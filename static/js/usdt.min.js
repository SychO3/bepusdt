(function () {
    'use strict';

    // 全局变量
    let countdownTimer = null;
    let statusCheckTimer = null;
    let totalSeconds = null;
    let paymentConfig = {};

    // 初始化配置
    function initConfig(config) {
        paymentConfig = config;
        totalSeconds = config.expire;
    }

    // 生成二维码
    function generateQRCode() {
        const qrContainer = document.getElementById('qrcode');
        const containerWidth = qrContainer.offsetWidth;
        const qrSize = Math.min(containerWidth - 10, 150); // 留出10px的边距
        $('#qrcode').empty();
        $('#qrcode').qrcode({
            text: paymentConfig.address,
            width: qrSize,
            height: qrSize,
            // 在深色背景上的二维码配色
            foreground: "#ffffff",
            background: "transparent",
            typeNumber: -1
        });
    }

    // 复制地址
    function copyAddress() {
        const address = document.getElementById('walletAddress').textContent;
        navigator.clipboard.writeText(address).then(function () {
            const btn = document.querySelector('.copy-btn');
            if (!btn) return;

            const originalText = btn.textContent;
            const originalBg = btn.style.background;
            const originalColor = btn.style.color;
            const originalShadow = btn.style.boxShadow;

            btn.textContent = '已复制';
            btn.style.background = 'linear-gradient(120deg, #22c55e, #4ade80)';
            btn.style.color = '#0f172a';
            btn.style.boxShadow = '0 12px 26px rgba(34, 197, 94, 0.6)';

            setTimeout(function () {
                btn.textContent = originalText;
                btn.style.background = originalBg;
                btn.style.color = originalColor;
                btn.style.boxShadow = originalShadow;
            }, 1600);
        }).catch(function (err) {
            console.error('复制失败: ', err);
            // 降级方案
            const textArea = document.createElement('textarea');
            textArea.value = address;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '已复制!';
                btn.style.background = '#48bb78';
                setTimeout(function () {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            } catch (err) {
                alert('复制失败，请手动复制地址');
            }
            document.body.removeChild(textArea);
        });
    }

    // 倒计时
    function startCountdown() {
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');

        function updateDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            if (totalSeconds <= 0) {
                minutesEl.textContent = '00';
                secondsEl.textContent = '00';
            } else {
                minutesEl.textContent = minutes.toString().padStart(2, '0');
                secondsEl.textContent = seconds.toString().padStart(2, '0');
            }

            // 当剩余时间少于5分钟时，倒计时高亮
            if (totalSeconds <= 300) { // 5分钟 = 300秒
                const banner = document.querySelector('.countdown-banner') || document.querySelector('.countdown-chip');
                if (banner) {
                    banner.style.background = 'linear-gradient(135deg, #ff4757, #ff3838)';
                }
            }

            // 当剩余时间少于1分钟时，添加紧急闪烁效果
            if (totalSeconds <= 60) {
                const banner = document.querySelector('.countdown-banner') || document.querySelector('.countdown-chip');
                if (banner) {
                    banner.style.animation = 'urgentBlink 1s infinite';
                }
            }
        }

        countdownTimer = setInterval(function () {
            totalSeconds--;
            updateDisplay();

            if (totalSeconds <= 0) {
                clearInterval(countdownTimer);
                clearInterval(statusCheckTimer);
                showTimeoutMessage();
            }
        }, 1000);

        // 初始化显示
        updateDisplay();
    }

    // 支付超时
    function showTimeoutMessage() {
        // 如果已有弹窗，避免重复创建
        if (document.getElementById('payment-overlay')) {
            return;
        }

        const overlay = document.createElement('div');
        overlay.id = 'payment-overlay';
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.86);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 18px;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
            background: rgba(5, 5, 16, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.85);
            padding: 20px 18px 16px;
            text-align: center;
            max-width: 420px;
            width: 100%;
            color: #ffffff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
        `;

        modal.innerHTML = `
            <div style="font-size: 40px; margin-bottom: 16px;">⏰</div>
            <h3 style="font-size: 18px; margin-bottom: 10px; color: #fecaca;">支付时间已过期</h3>
            <p style="font-size: 13px; color: #9b9bb3; margin-bottom: 18px; line-height: 1.6;">
                很抱歉，本次订单支付已超出允许时间窗口。<br>
                请返回商户平台重新发起支付或联系客服处理。
            </p>
            <button id="payment-timeout-back" style="
                background: linear-gradient(120deg, #ff3366, #ff7b9d);
                color: #ffffff;
                border: none;
                padding: 10px 22px;
                border-radius: 999px;
                cursor: pointer;
                font-size: 13px;
                box-shadow: 0 14px 30px rgba(255, 51, 102, 0.6);
                min-width: 150px;
            ">返回商户平台</button>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const backBtn = document.getElementById('payment-timeout-back');
        if (backBtn) {
            backBtn.addEventListener('click', function () {
                location.href = paymentConfig.return_url || '/';
            });
        }
    }

    // 等待网络确认
    function showWaitingConfirmation(data) {
        // 如果弹窗已存在，不重复创建
        if (document.getElementById('waiting-overlay')) {
            return;
        }

        const overlay = document.createElement('div');
        overlay.id = 'waiting-overlay';
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.86);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 18px;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
            background: rgba(5, 5, 16, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.85);
            padding: 20px 18px 18px;
            text-align: center;
            max-width: 420px;
            width: 100%;
            color: #ffffff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
        `;

        modal.innerHTML = `
            <div style="font-size: 40px; margin-bottom: 16px;">⏳</div>
            <h3 style="font-size: 18px; margin-bottom: 10px; color: #c7d2fe;">已检测到付款请求</h3>
            <p style="font-size: 13px; color: #9b9bb3; margin-bottom: 18px; line-height: 1.6;">
                交易已提交至区块网络，正在等待确认。<br>
                请勿重复支付，系统会自动更新订单状态。
            </p>
            <div style="display:flex;justify-content:center;margin-bottom:16px;">
                <div style="
                    width: 38px;
                    height: 38px;
                    border-radius: 999px;
                    border: 3px solid rgba(148, 163, 255, 0.25);
                    border-top-color: #6366f1;
                    animation: pg_spin 1s linear infinite;
                "></div>
            </div>
            <p style="color:#6b7280;font-size:12px;">
                预计确认时间：1-3 分钟，具体取决于当前网络拥堵情况。
            </p>
        `;

        // 旋转动画
        if (!document.getElementById('pg-spin-style')) {
            const style = document.createElement('style');
            style.id = 'pg-spin-style';
            style.textContent = `
                @keyframes pg_spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // 继续检查支付状态
        statusCheckTimer = setInterval(checkPaymentStatus, 5000);
    }

    // 支付成功
    function showSuccessMessage(data) {
        // 移除等待确认弹窗
        const waitingOverlay = document.getElementById('waiting-overlay');
        if (waitingOverlay) {
            waitingOverlay.remove();
        }

        // 如果已有成功弹窗，避免重复创建
        if (document.getElementById('payment-success-overlay')) {
            return;
        }

        const overlay = document.createElement('div');
        overlay.id = 'payment-success-overlay';
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.86);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 18px;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
            background: rgba(5, 5, 16, 0.98);
            border-radius: 20px;
            border: 1px solid rgba(34, 197, 94, 0.45);
            box-shadow: 0 30px 80px rgba(22, 163, 74, 0.65);
            padding: 22px 18px 18px;
            text-align: center;
            max-width: 420px;
            width: 100%;
            color: #ffffff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
        `;

        modal.innerHTML = `
            <div style="font-size: 40px; margin-bottom: 16px;">✅</div>
            <h3 style="font-size: 18px; margin-bottom: 10px; color: #bbf7d0;">支付成功</h3>
            <p style="font-size: 13px; color: #9b9bb3; margin-bottom: 16px; line-height: 1.6;">
                您的支付已在区块链上确认，系统已同步更新订单状态。
            </p>
            <p style="font-size: 12px; color: #a5b4fc; margin-bottom: 18px; word-break: break-all;">
                交易哈希：<br>
                <code style="background: rgba(15, 23, 42, 0.85); padding: 4px 8px; border-radius: 6px;">
                    ${data.trade_hash || '处理中...'}
                </code>
            </p>
            <button id="payment-success-back" style="
                background: linear-gradient(120deg, #22c55e, #4ade80);
                color: #0f172a;
                border: none;
                padding: 10px 22px;
                border-radius: 999px;
                cursor: pointer;
                font-size: 13px;
                min-width: 150px;
            ">返回商户平台</button>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const backBtn = document.getElementById('payment-success-back');
        if (backBtn) {
            backBtn.addEventListener('click', function () {
                location.href = data.return_url || '/';
            });
        }

        // 清除定时器
        if (countdownTimer) clearInterval(countdownTimer);
        if (statusCheckTimer) clearInterval(statusCheckTimer);
    }

    // 检查支付状态
    function checkPaymentStatus() {
        $.ajax({
            type: "GET",
            dataType: "json",
            url: "/pay/check-status/" + paymentConfig.trade_id,
            success: function (data) {
                if (data.status === 1) {
                    return setTimeout(checkPaymentStatus, 5000);  // 等待支付
                }
                if (data.status === 2) {
                    return showSuccessMessage(data);  // 支付成功
                }
                if (data.status === 3) {
                    return showTimeoutMessage(); // 支付超时
                }
                if (data.status === 5) {
                    return showWaitingConfirmation(data); // 等待网络确认
                }
            }
        });
    }

    // 初始化函数
    function init(config) {
        initConfig(config);
        generateQRCode();
        startCountdown();
        setTimeout(checkPaymentStatus, 2000);
    }

    // 暴露全局函数
    window.copyAddress = copyAddress;
    window.Payment = {
        init: init
    };

})();